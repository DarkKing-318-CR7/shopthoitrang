<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi"
      th:replace="admin/layout :: adminLayout(~{::body})">
<body>
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Trang quản trị</h1>

        <!-- HÀNG THỐNG KÊ NHANH -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Sản phẩm</h5>
                        <p class="card-text mb-2">
                            <span class="h3" th:text="${totalProducts}">0</span> sản phẩm
                        </p>
                        <a th:href="@{/admin/products}" class="btn btn-light btn-sm">Quản lý sản phẩm</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-warning mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Đơn hàng chờ duyệt</h5>
                        <p class="card-text mb-2">
                            <span class="h3" th:text="${pendingOrders}">0</span> đơn
                        </p>
                        <a th:href="@{/admin/orders}" class="btn btn-light btn-sm">Xem đơn hàng</a>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Người dùng</h5>
                        <p class="card-text mb-2">
                            <span class="h3" th:text="${totalUsers}">0</span> user
                        </p>
                        <a th:href="@{/admin/users}" class="btn btn-light btn-sm">Quản lý user</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- FORM LỌC DOANH THU -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Thống kê doanh thu</h5>

                <form class="row g-3 mb-3" method="get" th:action="@{/admin}">
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" name="from"
                               th:value="${from}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" name="to"
                               th:value="${to}">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary" type="submit">Lọc kết quả</button>
                    </div>
                </form>

                <canvas id="revenueChart" height="5"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">

    <!-- Line Chart: Cộng dồn -->
    <div class="col-md-6">
        <h4>Doanh thu cộng dồn</h4>
        <canvas id="chartCumulative"></canvas>
    </div>

    <!-- Bar Chart: Doanh thu từng ngày -->
    <div class="col-md-6">
        <h4>Doanh thu từng ngày</h4>
        <canvas id="chartDaily"></canvas>
    </div>

</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">5 đơn hàng chờ duyệt mới nhất</h4>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Mã đơn</th>
                            <th>Khách hàng</th>
                            <th>Ngày tạo</th>
                            <th class="text-end">Tổng tiền</th>
                            <th>Trạng thái</th>
                            <th class="text-center">Thao tác</th>
                        </tr>
                        </thead>

                        <tbody>
                        <!-- DANH SÁCH ĐƠN -->
                        <tr th:each="o : ${latestPendingOrders}">
                            <td th:text="${o.code}">ORD-0001</td>

                            <!-- Tên khách hàng (nếu có user) -->
                            <td th:text="${o.user != null ? o.user.fullName : 'Khách lẻ'}">
                                Nguyễn Văn A
                            </td>

                            <td th:text="${#temporals.format(o.createdAt, 'dd/MM/yyyy HH:mm')}">
                                24/11/2025 10:00
                            </td>

                            <td class="text-end"
                                th:text="${#numbers.formatDecimal((
                                            o.finalAmount != null ? o.finalAmount : o.totalAmount),
                                            0,'COMMA',0,'POINT'
                                         ) + ' VNĐ'}">
                                0 VNĐ
                            </td>

                            <td>
                                <span class="badge bg-warning text-dark"
                                      th:text="${o.status}">
                                    PENDING
                                </span>
                            </td>

                            <td class="text-center">
                                <a th:href="@{'/admin/orders/' + ${o.id}}"
                                   class="btn btn-sm btn-outline-primary">
                                    Xem
                                </a>
                            </td>
                        </tr>

                        <!-- Khi không có đơn -->
                        <tr th:if="${#lists.isEmpty(latestPendingOrders)}">
                            <td colspan="6" class="text-center text-muted py-3">
                                Không có đơn hàng chờ duyệt.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/

    const labels = /*[[${revenueLabels}]]*/ [];
    const dailyData = /*[[${revenueDailyData}]]*/ [];
    const cumulativeData = /*[[${revenueCumulativeData}]]*/ [];

    // =====================
    // 1️⃣ Biểu đồ Line – Cộng dồn
    // =====================
    new Chart(document.getElementById("chartCumulative"), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Doanh thu cộng dồn (VNĐ)",
                data: cumulativeData,
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 4
            }]
        },
        options: {
            plugins: { legend: { display: false }},
            scales: {
                y: {
                    ticks: {
                        callback: v => v.toLocaleString("vi-VN") + " đ"
                    }
                }
            }
        }
    });

    // =====================
    // 2️⃣ Biểu đồ Bar – Doanh thu từng ngày
    // =====================
    new Chart(document.getElementById("chartDaily"), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: "Doanh thu từng ngày (VNĐ)",
                data: dailyData,
                borderWidth: 1
            }]
        },
        options: {
            plugins: { legend: { display: false }},
            scales: {
                y: {
                    ticks: {
                        callback: v => v.toLocaleString("vi-VN") + " đ"
                    }
                }
            }
        }
    });

    /*]]>*/
</script>

</body>
</html>
